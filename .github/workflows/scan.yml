name: Security-Testing-Phase
on:
  workflow_dispatch:

jobs:
  testing-and-exploitation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Recon Data
        uses: actions/checkout@v4

      - name: Install Toolset
        run: |
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          pip install arjun
          sudo mv ~/go/bin/nuclei /usr/local/bin/

      - name: 1. Nuclei Scan
        id: nuclei
        # continue-on-error ensures the workflow doesn't stop if Nuclei fails
        continue-on-error: true 
        run: |
          nuclei -list recon/nuclei_targets.txt -severity critical,high,medium -jsonl -o nuclei_results.json -rl 50

      - name: 2. Arjun Parameter Discovery
        id: arjun
        continue-on-error: true
        run: |
          head -n 25 recon/arjun_targets.txt > active_targets.txt
          arjun -i active_targets.txt -oJ arjun_results.json --stable

      - name: 3. Create Report (Runs even on failure)
        # if: always() ensures this runs even if the previous steps crashed
        if: always() 
        run: |
          echo "{" > n8n_report.json
          echo "  \"timestamp\": \"$(date)\"," >> n8n_report.json
          echo "  \"nuclei_findings\": $(cat nuclei_results.json | jq -s '.' || echo "[]")," >> n8n_report.json
          echo "  \"arjun_params\": $(cat arjun_results.json || echo "[]")" >> n8n_report.json
          echo "}" >> n8n_report.json

      - name: 4. Save Results to Repo (Crash-Proof)
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # Only add files that actually exist to avoid new errors
          git add n8n_report.json nuclei_results.json arjun_results.json || true
          git commit -m "Results (including partial data on failure)" || exit 0
          git push

      - name: 5. Upload Artifacts (Last Resort)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manual-test-results
          # This saves any file that was created, even if the job failed
          path: |
            nuclei_results.json
            arjun_results.json
            n8n_report.json
          if-no-files-found: warn
          
