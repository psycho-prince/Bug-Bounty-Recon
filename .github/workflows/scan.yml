name: Apex-oombi
on:
  workflow_dispatch:

jobs:
  # JOB 1: DNS & TAKEOVERS (Independent)
  dns-takeover:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Tools
        run: |
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/haccer/subjack@latest
          sudo mv ~/go/bin/* /usr/local/bin/
      - name: Scan Takeovers
        run: |
          subfinder -d openai.com -silent > all_subs.txt
          subjack -w all_subs.txt -t 100 -timeout 30 -o takeover_results.txt -ssl || true
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: dns-findings
          path: takeover_results.txt

  # JOB 2: GITHUB LEAK PARSER (Independent - No Network Required)
  github-leaks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Parse Local Leaks JSON
        run: |
          mkdir -p github_findings
          # Extracting URLs from your 6,128 hits
          jq -r '.items[].html_url' leaks.json > github_findings/links.txt
          # Count most suspicious file names
          jq -r '.items[].name' leaks.json | sort | uniq -c | sort -nr > github_findings/file_counts.txt
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: github-leaks
          path: github_findings/

  # JOB 3: VULNERABILITY SCANNING (Nuclei)
  vuln-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Nuclei Scan
        run: |
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          sudo mv ~/go/bin/nuclei /usr/local/bin/
          # Scanning known subdomains for high-severity CVEs
          nuclei -u https://openai.com,https://chatgpt.com,https://platform.openai.com -severity critical,high -o vuln_results.txt
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-results
          path: vuln_results.txt

  # JOB 4: HISTORY ANALYSIS (Memory Intensive)
  history-logic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Reassemble & Grep
        run: |
          curl -L "https://docs.google.com/uc?export=download&id=1vD2GpVHiMlR1wmoQfxcZfIpKeCRuadZx" -o history.txt
          mkdir -p history_out
          # Hunting for the 'Gold' in your 25MB file
          grep -iE "apikey=|token=|secret=|auth=" history.txt > history_out/secrets.txt || true
          grep -iE "\.env|\.git|\.config|\.bak|\.sql" history.txt > history_out/files.txt || true
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: history-data
          path: history_out/

  # JOB 5: FINAL AGGREGATOR (Wait for all to finish)
  final-report:
    needs: [dns-takeover, github-leaks, vuln-scan, history-logic]
    if: always() # Run even if one of the above fails
    runs-on: ubuntu-latest
    steps:
      - name: Download all
        uses: actions/download-artifact@v4
      - name: Merge Report
        run: |
          echo "=== APEX MASTER REPORT ===" > summary.txt
          echo "DNS: $(cat dns-findings/takeover_results.txt || echo 'No Takeovers')" >> summary.txt
          echo "Vulns: $(cat nuclei-results/vuln_results.txt || echo 'No Vulns')" >> summary.txt
          echo "GitHub links found: $(wc -l < github-leaks/links.txt)" >> summary.txt
      - name: Final Upload
        uses: actions/upload-artifact@v4
        with:
          name: COMPLETE-REPORT
          path: summary.txt
          
