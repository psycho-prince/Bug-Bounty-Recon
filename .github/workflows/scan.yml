name: OpenAI-Max-Coverage-Security-Engine

on:
  workflow_dispatch:
    inputs:
      target_domain:
        description: 'Domain to hunt (e.g., openai.com)'
        required: true
        default: 'openai.com'

jobs:
  security-intel:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Hours

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt update
        sudo apt install -y jq parallel nmap dnsutils libpcap-dev build-essential

    - name: Install Full Arsenal
      run: |
        go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
        go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
        go install -v github.com/projectdiscovery/katana/cmd/katana@latest
        go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
        go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
        pip install arjun
        sudo mv ~/go/bin/* /usr/local/bin/

    # ---------------- PHASE 1: RAPID RECON ----------------

    - name: Asset Discovery
      run: |
        echo "${{ github.event.inputs.target_domain }}" > scope.txt
        subfinder -dL scope.txt -all -silent -o subs.txt
        # Only Web Ports to save massive amounts of time
        sudo naabu -list subs.txt -p 80,443,8080,8443 -silent -rate 1000 -o ports.txt
        httpx -list ports.txt -sc -cl -td -silent -o live.txt
        # EMERGENCY BACKUP: Save recon data immediately
        mkdir -p results && cp live.txt results/live_backup.txt

    # ---------------- PHASE 2: LIGHTWEIGHT MAPPING ----------------

    - name: Surface Mapping
      run: |
        # Katana: NO-JS-PARSING (-njs) and Scoped Depth to stay under time
        # -ct 600 limits each target to 10 minutes max
        katana -list live.txt -njs -d 2 -ct 600 -rl 30 -o endpoints.txt || true

        # Clean URLs for Arjun
        grep -oP 'https?://[^\s\[\]]+' live.txt | sort -u | head -n 20 > arjun_targets.txt
        
        # Arjun: Only test the first 20 targets to ensure completion
        if [ -s arjun_targets.txt ]; then
          arjun -i arjun_targets.txt --stable -t 10 -oT params.txt || echo "Arjun skipped"
        fi

    # ---------------- PHASE 3: FOCUSED ATTACK ----------------

    - name: Deep 403/404 Bypass Sweep
      run: |
        grep -oP 'https?://[^\s\[\]]+' endpoints.txt | sort -u > clean_endpoints.txt
        httpx -list clean_endpoints.txt -path "//" \
          -H "X-OpenAI-Internal: true" \
          -H "X-Forwarded-For: 127.0.0.1" \
          -sc -cl -o bypass_findings.txt || true

    - name: Nuclei Vulnerability Sweep
      run: |
        grep -oP 'https?://[^\s\[\]]+' live.txt | sort -u > nuclei_targets.txt
        # ONLY Critical/High templates to save time
        nuclei -list nuclei_targets.txt -severity critical,high -o nuclei_findings.txt || true

    # ---------------- PHASE 4: ALWAYS UPLOAD ----------------

    - name: Package & Upload Evidence
      if: always() # CRITICAL: Captures data even on timeout
      run: |
        mkdir -p results
        mv *.txt results/ || true
        mv *.json results/ || true
        tar -czf security-results.tar.gz results

    - name: Upload Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bug-hunt-results
        path: security-results.tar.gz
        retention-days: 5
        
