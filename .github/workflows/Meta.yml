name: Meta Recon Engine

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  recon:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go Environment
        run: |
          echo "GOPATH=$HOME/go" >> $GITHUB_ENV
          echo "PATH=$PATH:$HOME/go/bin" >> $GITHUB_ENV

      - name: Cache Go Modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Install System Dependencies
        run: |
          sudo apt update
          sudo apt install -y jq unzip python3-pip

      - name: Install Recon Toolchain
        run: |
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/projectdiscovery/notify/cmd/notify@latest
          go install github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
          pip3 install uro

      - name: Verify Tools
        run: |
          which subfinder
          which httpx
          which katana
          which nuclei
          which naabu
          which notify
          which uro

      - name: Subdomain Enumeration
        run: |
          subfinder -dL scope_expanded.txt -all -silent > subs.txt

      - name: HTTP Probing
        run: |
          httpx -l subs.txt -threads 100 -silent -status-code -title -tech-detect -json > alive.json
          jq -r '.url' alive.json > alive.txt

      - name: Port Scanning
        run: |
          naabu -l alive.txt -top-ports 1000 -silent > ports.txt

      - name: Web Crawling
        run: |
          katana -l alive.txt -jc -kf -ef woff,css,png,jpg,svg,woff2 -o crawl.txt

      - name: URL Deduplication
        run: |
          cat crawl.txt | uro > urls.txt

      - name: Vulnerability Scan
        run: |
          nuclei -l alive.txt -severity medium,high,critical -o nuclei.txt

      - name: Upload Recon Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: meta-recon
          path: |
            subs.txt
            alive.json
            alive.txt
            ports.txt
            crawl.txt
            urls.txt
            nuclei.txt
